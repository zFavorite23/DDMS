{"remainingRequest":"D:\\DDMS\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\DDMS\\src\\views\\apply\\invoice\\Form.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\DDMS\\src\\views\\apply\\invoice\\Form.vue","mtime":1594003835349},{"path":"D:\\DDMS\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\DDMS\\node_modules\\thread-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\DDMS\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\DDMS\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\DDMS\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\r\nimport { addObj, editObj, getInvoices } from '../../../api/apply/invoice.js';\r\nimport { getApplyUserInfo } from '../../../api/admin/user.js';\r\nimport { getItemVosWithUserId } from '../../../api/project/team.js';\r\nimport { getStandardApplyInfoById } from '../../../api/standard/apply.js';\r\nimport { mapGetters } from 'vuex';\r\nexport default {\r\n    data() {\r\n        return {\r\n            query: {\r\n                companyId: null,\r\n                userId: null,\r\n                deptId: null,\r\n                itemId: null,\r\n                type: 6,\r\n                priceYuan: 0\r\n            },\r\n            labelPosition: 'right',\r\n            fileList1: [],\r\n            fileList2: [],\r\n            formData: {\r\n                newData: true,\r\n                invoiceId: null,\r\n                companyId: null,\r\n                itemId: null,\r\n                userId: null,\r\n                type1: '',\r\n                type2: '',\r\n                type3: '',\r\n                isFull: '0',\r\n                invoiceType: '2',\r\n                invoiceDesc: '',\r\n                invoiceTime: '',\r\n                invoicePriceYuan: null,\r\n                invoiceImg: '',\r\n                invoiceImgNum: null,\r\n                payDesc: '',\r\n                payTime: '',\r\n                payPriceYuan: null,\r\n                payImg: '',\r\n                payImgNum: null,\r\n                approverids: ''\r\n            },\r\n            isSave: true,\r\n            uploadUrl: '',\r\n            companyOptions: [\r\n                {\r\n                    value: 1,\r\n                    label: '未转正不可提交',\r\n                    disabled: true\r\n                },\r\n                {\r\n                    value: 2,\r\n                    label: '北京甲板智慧科技有限公司',\r\n                    disabled: true\r\n                },\r\n                {\r\n                    value: 3,\r\n                    label: '北京甲板数字科技有限公司',\r\n                    disabled: true\r\n                }\r\n            ],\r\n            itemOptions: [],\r\n            productOptions: [],\r\n            rules: {\r\n                companyId: [{ required: true, message: '请选择公司', trigger: 'change' }],\r\n                itemId: [{ required: true, message: '请选择项目', trigger: 'change' }],\r\n                type1: [\r\n                    {\r\n                        required: true,\r\n                        message: '请选择总分类',\r\n                        trigger: 'change'\r\n                    }\r\n                ],\r\n                type2: [\r\n                    {\r\n                        required: true,\r\n                        message: '请选择主分类',\r\n                        trigger: 'change'\r\n                    }\r\n                ],\r\n                type3: [\r\n                    {\r\n                        required: true,\r\n                        message: '请选择明细分类',\r\n                        trigger: 'change'\r\n                    }\r\n                ],\r\n                isFull: [\r\n                    {\r\n                        required: true,\r\n                        message: '请选择是否找的票',\r\n                        trigger: 'change'\r\n                    }\r\n                ],\r\n                invoiceType: [\r\n                    {\r\n                        required: true,\r\n                        message: '请选择发票类型',\r\n                        trigger: 'change'\r\n                    }\r\n                ],\r\n                payDesc: [{ required: true, message: '请填写支付描述' }],\r\n                payTime: [\r\n                    {\r\n                        required: true,\r\n                        message: '请选择支付时间',\r\n                        trigger: 'change'\r\n                    }\r\n                ],\r\n                payPriceYuan: [{ required: true, message: '请填写支付金额' }],\r\n                payImg: [\r\n                    {\r\n                        required: true,\r\n                        message: '请上传支付图片',\r\n                        trigger: 'change'\r\n                    }\r\n                ],\r\n                payImgNum: [{ required: true, message: '请填写支付图片数量' }],\r\n                invoiceDesc: [{ required: true, message: '请填写发票描述' }],\r\n                invoiceTime: [\r\n                    {\r\n                        required: true,\r\n                        message: '请选择发票时间',\r\n                        trigger: 'change'\r\n                    }\r\n                ],\r\n                invoicePriceYuan: [{ required: true, message: '请填写发票金额' }],\r\n                // invoiceImg: [\r\n                //     {\r\n                //         required: true,\r\n                //         message: '请上传发票图片',\r\n                //         trigger: 'change'\r\n                //     }\r\n                // ],\r\n                invoiceImgNum: [{ required: true, message: '请填写发票图片数量' }]\r\n            },\r\n            saving: false,\r\n            applyUserList: [],\r\n            isDisabled: false,\r\n            sumClassifyOptions: [],\r\n            mainClassifyOptions: [],\r\n            subClassifyOptions: [],\r\n            pickerOptions1: {\r\n                disabledDate(time) {\r\n                    return time.getTime() < new Date().getTime() - 3600 * 1000 * 24 * 94 || time.getTime() > new Date().getTime() + 3600 * 1000 * 24 * 0;\r\n                }\r\n            }\r\n        };\r\n    },\r\n    created() {\r\n        const editInvoiceInfo = JSON.parse(window.localStorage.getItem('editInvoiceInfo'));\r\n        console.log(editInvoiceInfo);\r\n        if (editInvoiceInfo) {\r\n            this.formData.newData = false;\r\n            this.formData.invoiceId = editInvoiceInfo.invoiceId;\r\n            this.formData.companyId = editInvoiceInfo.companyId;\r\n            this.query.companyId = editInvoiceInfo.companyId;\r\n            this.formData.itemId = editInvoiceInfo.itemId;\r\n            this.query.itemId = editInvoiceInfo.itemId;\r\n            this.formData.type1 = editInvoiceInfo.type1;\r\n            if(editInvoiceInfo.itemId!=null){\r\n                this.formData.type2 = [editInvoiceInfo.type2,editInvoiceInfo.itemId]\r\n            }else {\r\n                this.formData.type2 = [editInvoiceInfo.type2]\r\n            }\r\n            this.formData.type3 = editInvoiceInfo.type3;\r\n            this.formData.isFull = editInvoiceInfo.isFull;\r\n            this.formData.invoiceType = editInvoiceInfo.invoiceType;\r\n            this.formData.invoiceDesc = editInvoiceInfo.invoiceDesc;\r\n            this.formData.invoiceTime = editInvoiceInfo.invoiceTime;\r\n            this.formData.invoicePriceYuan = editInvoiceInfo.invoicePriceYuan;\r\n            this.formData.invoiceImgNum = editInvoiceInfo.invoiceImgNum;\r\n            this.formData.invoiceImg = editInvoiceInfo.invoiceImg;\r\n            this.formData.payDesc = editInvoiceInfo.payDesc;\r\n            this.formData.payTime = editInvoiceInfo.payTime;\r\n            this.formData.payPriceYuan = editInvoiceInfo.payPriceYuan;\r\n            this.formData.payImgNum = editInvoiceInfo.payImgNum;\r\n            this.formData.payImg = editInvoiceInfo.payImg;\r\n            this.applyUserList = editInvoiceInfo.checkUserList;\r\n            //console.log(editInvoiceInfo.invoiceImg)\r\n            getInvoices(this.formData.type1, this.userId).then(res => {\r\n                res.data.data.invoiceType.forEach(item => {\r\n                    this.mainClassifyOptions.push({\r\n                        value: item.id,\r\n                        label: item.name,\r\n                        children: item.children\r\n                    });\r\n                });\r\n            });\r\n            getInvoices(this.formData.type2[0], this.userId).then(res => {\r\n                this.subClassifyOptions = res.data.data.invoiceType;\r\n            });\r\n            if (editInvoiceInfo.payImg) {\r\n                editInvoiceInfo.payImg.split(',').forEach((item, index) => {\r\n                    if (item) {\r\n                        //console.log(item)\r\n                        this.fileList1.push({\r\n                            url: `${window.location.origin}/apply/invoice/` + item\r\n                        });\r\n                    }\r\n                });\r\n            }\r\n            if (editInvoiceInfo.invoiceImg) {\r\n                editInvoiceInfo.invoiceImg.split(',').forEach((item, index) => {\r\n                    if (item) {\r\n                        this.fileList2.push({\r\n                            url: `${window.location.origin}/apply/invoice/` + item\r\n                        });\r\n                    }\r\n                });\r\n            }\r\n        }\r\n        this.getItemVosWithUserId(this.userId);\r\n\r\n        if (!this.companyId) {\r\n            this.isSave = false;\r\n        } else {\r\n            this.formData.companyId = this.companyId;\r\n        }\r\n        //console.log(this.formData.companyId);\r\n        this.getStandardApplyInfo();\r\n        this.getApplyUser(this.userId);\r\n        this.formData.userId = this.userId;\r\n        this.query.userId = this.userId;\r\n        this.getInvoices('-1', this.query.userId);\r\n        this.uploadUrl = `${window.location.origin}/apply/invoice/upload`;\r\n        //this.open()\r\n    },\r\n    computed: {\r\n        ...mapGetters(['permissions', 'userId', 'companyId'])\r\n    },\r\n    methods: {\r\n        // 总分类\r\n        getInvoices(id, userId) {\r\n            getInvoices(id, userId).then(res => {\r\n                // console.log(res)\r\n                this.sumClassifyOptions = res.data.data.invoiceType;\r\n            });\r\n        },\r\n\r\n        // 主分类\r\n        classifyChange(val) {\r\n            console.log(val);\r\n            // if (val == '10') {\r\n            //     this.formData.isFull = '1';\r\n            //     this.isDisabled = true;\r\n            // } else if (val == '11' || val == '12') {\r\n            //     this.formData.itemId = '';\r\n            //     this.isDisabled = false;\r\n            // } else {\r\n            //     this.isDisabled = false;\r\n            // }\r\n            this.mainClassifyOptions = [];\r\n            this.subClassifyOptions = [];\r\n\r\n            getInvoices(val, this.userId).then(res => {\r\n                // console.log(res)\r\n                res.data.data.invoiceType.forEach(item => {\r\n                    this.mainClassifyOptions.push({\r\n                        value: item.id,\r\n                        label: item.name,\r\n                        children: item.children\r\n                    });\r\n                });\r\n            });\r\n        },\r\n\r\n        // 明细分类\r\n        classifyChange2(val) {\r\n            this.query.itemId = null\r\n            this.formData.itemId = null\r\n            getInvoices(val[0], this.userId).then(res => {\r\n                // console.log(res)\r\n                this.subClassifyOptions = res.data.data.invoiceType;\r\n            });\r\n\r\n            // 获取项目id\r\n            if (val.length > 1 && val.length < 3) {\r\n                this.query.itemId = val[1];\r\n                this.formData.itemId = val[1];\r\n                this.getApplyUser();\r\n            } else if (val.length == 3) {\r\n                this.query.itemId = val[2];\r\n                this.formData.itemId = val[2];\r\n                this.getApplyUser();\r\n            } else {\r\n                this.query.itemId = null;\r\n                this.formData.itemId = null;\r\n            }\r\n        },\r\n\r\n        // selectItem(val) {\r\n        //     if (val == null || val == '') {\r\n        //         this.query.itemId = null;\r\n        //         this.formData.itemId = null;\r\n        //         this.getApplyUser();\r\n        //     } else {\r\n        //         this.query.itemId = val;\r\n        //         this.formData.itemId = val;\r\n        //         this.getApplyUser();\r\n        //     }\r\n        // },\r\n        getItemVosWithUserId(userId) {\r\n            getItemVosWithUserId(userId).then(response => {\r\n                response.data.data.forEach(element => {\r\n                    if (element.type == 1) {\r\n                        this.itemOptions.push({\r\n                            value: element.itemId,\r\n                            label: element.alias\r\n                        });\r\n                    }\r\n                    if (element.type == 2) {\r\n                        this.productOptions.push({\r\n                            value: element.itemId,\r\n                            label: element.alias\r\n                        });\r\n                    }\r\n                });\r\n            });\r\n        },\r\n        getApplyUser() {\r\n            // if (this.formData.classify != 10) {\r\n            if (this.formData.isFull == '1') {\r\n                this.query.priceYuan = this.formData.payPriceYuan;\r\n            } else {\r\n                this.query.priceYuan = this.formData.invoicePriceYuan;\r\n            }\r\n            \r\n            console.log(this.query)\r\n\r\n            getApplyUserInfo(this.query).then(response => {\r\n                this.applyUserList = [];\r\n                this.formData.approverids = null;\r\n                console.log(response)\r\n                response.data.data.forEach(element => {\r\n                    this.applyUserList.push({\r\n                        userId: element.userId,\r\n                        username: element.username,\r\n                        avatar: element.avatar\r\n                    });\r\n                    if (this.formData.approverids == null) {\r\n                        this.formData.approverids += element.userId;\r\n                    } else {\r\n                        this.formData.approverids += ',' + element.userId;\r\n                    }\r\n                });\r\n            });\r\n            // } else {\r\n            //     this.applyUserList = [];\r\n            //     this.formData.approverids = 23;\r\n            //     this.applyUserList.push({\r\n            //         userId: 23,\r\n            //         username: '王海清',\r\n            //         avatar: 'http://thirdwx.qlogo.cn/mmopen/vi_32/qZ3bvj9j1Kicjee8pBmwQUibV3pFRHRWZVHmIFj0CIFmMVtklCOKicU1f8KYdIKJkYGYSZmGaWqVu5iasmPH5ECkQw/132'\r\n            //     });\r\n            // }\r\n        },\r\n        backHistory() {\r\n            window.localStorage.removeItem('editInvoiceInfo');\r\n            this.formData.newData = true;\r\n            this.formData.invoiceId = null;\r\n            this.formData.companyId = null;\r\n            this.formData.itemId = null;\r\n            this.formData.userId = null;\r\n            this.formData.type1 = '';\r\n            this.formData.type2 = '';\r\n            this.formData.type3 = '';\r\n            this.formData.isFull = '0';\r\n            this.formData.invoiceType = '2';\r\n            this.formData.invoiceDesc = '';\r\n            this.formData.invoiceTime = '';\r\n            this.formData.invoicePrice = null;\r\n            this.formData.invoiceImgNum = null;\r\n\r\n            this.formData.payDesc = '';\r\n            this.formData.payTime = '';\r\n            this.formData.payPrice = null;\r\n            this.formData.payImgNum = null;\r\n\r\n            this.$router.go(-1);\r\n        },\r\n        onSubmit() {\r\n            this.formData.type2 = this.formData.type2[0];\r\n            console.log(this.formData);\r\n            this.$refs['formData'].validate(valid => {\r\n                if (valid) {\r\n                    this.saving = true;\r\n                    console.log(this.formData.newData);\r\n                    this.$confirm('请申请人复核发票信息、发票内容、发票金额后再提交，一经提交后流程不能逆转。', '温馨提示：', {\r\n                        confirmButtonText: '确定',\r\n                        cancelButtonText: '取消',\r\n                        type: 'warning',\r\n                        showClose: false\r\n                    })\r\n                        .then(() => {\r\n                            if (!this.formData.newData) {\r\n                                editObj(this.formData)\r\n                                    .then(res => {\r\n                                        if (res.data.data) {\r\n                                            this.backHistory();\r\n                                        }\r\n                                    })\r\n                                    .finally(() => {\r\n                                        this.saving = false;\r\n                                    });\r\n                            } else {\r\n                                addObj(this.formData)\r\n                                    .then(res => {\r\n                                        if (res.data.data) {\r\n                                            this.backHistory();\r\n                                        }\r\n                                    })\r\n                                    .finally(() => {\r\n                                        this.saving = false;\r\n                                    });\r\n                            }\r\n                        })\r\n                        .catch(() => {\r\n                            this.saving = false;\r\n                        });\r\n                }\r\n            });\r\n        },\r\n        handleRemove1(data) {\r\n            var serverUrl = `${window.location.origin}/apply/invoice/`;\r\n            const imgUrl = data.url.replace(serverUrl, '');\r\n            this.formData.payImg = this.formData.payImg.replace(imgUrl + ',', '');\r\n        },\r\n        handlePreview1(file) {\r\n            console.log(file);\r\n        },\r\n        handSuccess1(data) {\r\n            const imgInfo = data.data;\r\n            const imgUrl = imgInfo.bucketName + '-' + imgInfo.fileName;\r\n            this.formData.payImg += imgUrl + ',';\r\n        },\r\n        handleRemove2(data) {\r\n            var serverUrl = `${window.location.origin}/apply/invoice/`;\r\n            const imgUrl = data.url.replace(serverUrl, '');\r\n            this.formData.invoiceImg = this.formData.invoiceImg.replace(imgUrl + ',', '');\r\n        },\r\n        handlePreview2(file) {\r\n            console.log(file);\r\n        },\r\n        handSuccess2(data) {\r\n            const imgInfo = data.data;\r\n            const imgUrl = imgInfo.bucketName + '-' + imgInfo.fileName;\r\n            this.formData.invoiceImg += imgUrl + ',';\r\n        },\r\n        getStandardApplyInfo() {\r\n            getStandardApplyInfoById(6).then(response => {\r\n                if (response.data.data) {\r\n                    const data = response.data.data;\r\n                    this.content = data.content;\r\n                    const invoiceStandardApply = JSON.parse(window.localStorage.getItem('invoiceStandardApply'));\r\n                    if (invoiceStandardApply) {\r\n                        if (invoiceStandardApply.version < data.version) {\r\n                            this.open();\r\n                        }\r\n                    } else {\r\n                        this.open();\r\n                    }\r\n                    window.localStorage.setItem('invoiceStandardApply', JSON.stringify(data));\r\n                }\r\n            });\r\n        },\r\n        open() {\r\n            let content = this.content.split('\\n\\n');\r\n            let newDatas = [];\r\n            const h = this.$createElement;\r\n            for (let i in content) {\r\n                newDatas.push(h('p', null, content[i]));\r\n            }\r\n            this.$alert(h('div', null, newDatas), '报销规范');\r\n        },\r\n        beforeAvatarUpload: function(file) {\r\n            const isJPG = file.type === 'image/jpeg';\r\n            const isPNG = file.type === 'image/png';\r\n            const isPG = isJPG || isPNG; //限制图片格式为jpg / png\r\n            const isLt5M = file.size / 1024 / 1024 < 5; //限制图片大小\r\n            if (!isPG) {\r\n                this.$message.error('上传头像图片只能是 JPG 或 PNG 格式!');\r\n            }\r\n            if (!isLt5M) {\r\n                this.$message.error('上传头像图片大小不能超过 5MB!');\r\n            }\r\n            return isPG && isLt5M;\r\n        }\r\n    },\r\n    mounted() {}\r\n};\r\n",null]}